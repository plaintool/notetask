name: Create Issue from Commit
on:
  push:
    branches:
      - master
jobs:
  create_issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine issue type
        id: check
        run: |
          msg="${{ github.event.head_commit.message }}"
          upper_msg=$(echo "$msg" | tr '[:lower:]' '[:upper:]')
          if [[ "$upper_msg" == *"FIX:"* ]]; then
            echo "type=Bug" >> $GITHUB_OUTPUT
          elif [[ "$upper_msg" == *"FEATURE:"* ]]; then
            echo "type=Feature" >> $GITHUB_OUTPUT
          else
            echo "type=None" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Issue via API
        if: steps.check.outputs.type != 'None'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_ID: ${{ github.event.head_commit.id }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          ISSUE_LABEL: ${{ steps.check.outputs.type }}
        run: |
          TITLE=$(echo "$COMMIT_MSG" | sed -E 's/^(FIX|FEATURE):\s*//i')
          BODY="**Commit:** https://github.com/$GITHUB_REPOSITORY/commit/$COMMIT_ID\n**Author:** $COMMIT_AUTHOR\n\nThis issue was automatically created from commit $COMMIT_ID"
          
          JSON="{\"title\":\"$TITLE\",\"body\":\"$BODY\",\"labels\":[\"$ISSUE_LABEL\",\"Auto\"]}"
          
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/issues \
            -d "$JSON")
          
          ISSUE_NUMBER=$(echo "$RESPONSE" | grep -o '"number":[0-9]*' | cut -d: -f2)
          
          if [ -n "$ISSUE_NUMBER" ]; then
            curl -s -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$ISSUE_NUMBER \
              -d '{"state":"closed"}'
            
            echo "Created and closed issue #$ISSUE_NUMBER for commit $COMMIT_ID"
          fi