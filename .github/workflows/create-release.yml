name: Create Release
on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
      artifact_name:
        required: false
        type: string
        default: build-artifacts
  workflow_dispatch:
    inputs:
      tag_name:
        description: Release tag to create
        required: true
        type: string
      artifact_name:
        description: Artifact name to attach
        required: false
        default: build-artifacts

permissions:
  contents: write
  issues: read

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog from issues
        id: changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issues: true
          pullRequests: false
          onlyLastTag: true
          excludeLabels: 'duplicate,question,invalid,wontfix'
          configureSections: |
              {
                "features": {
                  "prefix": "### üöÄ New Features",
                  "labels": ["feature", "feature auto"]
                },
                "enhancements": {
                  "prefix": "### ‚ú® Enhancements",
                  "labels": ["enhancement", "enhancement auto"]
                },
                "bugfixes": {
                  "prefix": "### üêõ Fixed Bugs",
                  "labels": ["bug", "bug auto"]
                }
              }
          output: CHANGELOG.md

      - name: Show generated changelog
        run: cat CHANGELOG.md

      - name: Append installation section
        run: |
          TAG="${{ inputs.tag_name != '' && inputs.tag_name || github.event.inputs.tag_name }}"
          VERSION="${TAG#v}"

          cp CHANGELOG.md RELEASE.md
          cat <<EOF >> RELEASE.md
          
          ---

          # Installation

          ## Windows

          Several installer options are available on the releases page:

          - [**notetask-${VERSION}-any-x86-x64.exe**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-any-x86-x64.exe) ‚Äî a universal EXE installer that works on **both x86 and x64** systems and supports installation **for a single user or for all users**, depending on the selected options.
          - [**notetask-${VERSION}-x64.msi**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-x64.msi) / [**notetask-${VERSION}-x86.msi**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-x86.msi) ‚Äî installs the application **for the current user**.
          - [**notetask-${VERSION}-x64-allusers.msi**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-x64-allusers.msi) / [**notetask-${VERSION}-x86-allusers.msi**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-x86-allusers.msi) ‚Äî installs the application **for all users on the system**.
          - [**notetask-${VERSION}-x86-x64-portable.zip**](https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}-x86-x64-portable.zip) ‚Äî portable version, saves its settings to \`form_settings.json\` if it is near the executable; otherwise, in the user directory

          > **Note:** Windows XP supports installation **only via MSI installers**. The EXE installer is **not compatible** with Windows XP.

          ## Linux
          
          ### *Debian-like systems (Debian, Ubuntu, etc.)*

          \`\`\`bash
          wget https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}.deb
          sudo apt install ./notetask-${VERSION}.deb
          \`\`\`

          ### *RPM-based systems (Fedora, RHEL, CentOS, openSUSE, etc.)*

          \`\`\`bash
          wget https://github.com/plaintool/notetask/releases/download/${TAG}/notetask-${VERSION}.rpm
          sudo rpm -i ./notetask-${VERSION}.rpm
          \`\`\`
          EOF

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifact_name || github.event.inputs.artifact_name }}
          path: dist
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag_name || github.event.inputs.tag_name }}
          body_path: RELEASE.md
          draft: true
          prerelease: false
          files: |
            dist/**/*.exe
            dist/**/*.msi
            dist/**/*.zip
            dist/**/*.deb
            dist/**/*.rpm
            dist/**/*.tar.gz
