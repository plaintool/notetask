name: Create Release
on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
      artifact_name:
        required: false
        type: string
        default: build-artifacts
  workflow_dispatch:
    inputs:
      tag_name:
        description: Release tag to create
        required: true
        type: string
      artifact_name:
        description: Artifact name to attach
        required: false
        default: build-artifacts

permissions:
  contents: write
  issues: read

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog from issues
        id: changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issues: true
          pullRequests: false
          onlyLastTag: true
          excludeLabels: 'duplicate,question,invalid,wontfix'
          configureSections: |
              {
                "features": {
                  "prefix": "### üöÄ New Features",
                  "labels": ["feature", "feature auto"]
                },
                "enhancements": {
                  "prefix": "### ‚ú® Enhancements",
                  "labels": ["enhancement", "enhancement auto"]
                },
                "bugfixes": {
                  "prefix": "### üêõ Fixed Bugs",
                  "labels": ["bug", "bug auto"]
                }
              }
          output: CHANGELOG.md

      - name: Show generated changelog
        run: cat CHANGELOG.md

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifact_name || github.event.inputs.artifact_name }}
          path: dist
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag_name || github.event.inputs.tag_name }}
          body_path: CHANGELOG.md
          draft: true
          prerelease: false
          files: |
            dist/**/*.exe
            dist/**/*.msi
            dist/**/*.zip
            dist/**/*.deb
            dist/**/*.rpm
            dist/**/*.tar.gz
